# DoAi.Me Cloud Gateway - Caddy Configuration
# 자동 HTTPS + WebSocket 프록시

api.doai.me {
    # WebSocket 프록시 (/ws/node)
    @websocket {
        header Connection *Upgrade*
        header Upgrade websocket
    }
    
    reverse_proxy @websocket gateway:8000 {
        # WebSocket 설정
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        
        # WebSocket 타임아웃 (긴 연결 유지)
        transport http {
            keepalive 30s
            keepalive_idle_conns 10
        }
    }
    
    # REST API 프록시
    reverse_proxy gateway:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
    
    # CORS 헤더
    header {
        Access-Control-Allow-Origin *
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization"
    }
    
    # 로깅
    log {
        output file /var/log/caddy/access.log {
            roll_size 10mb
            roll_keep 5
        }
        format json
    }
}

# Health check endpoint (내부용)
:8080 {
    respond /health "OK" 200
}

