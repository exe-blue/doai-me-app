# Vultr Integration Guide

## ê°œìš”

ê¸°ì¡´ `gateway`ì— Vultr `cloud-gateway` ì—°ê²°ì„ ì¶”ê°€í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

## ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        VULTR SERVER                             â”‚
â”‚                   cloud-gateway (Python)                        â”‚
â”‚                        WSS Hub                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ WSS Protocol v1.0
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     MINI PC (x15)                               â”‚
â”‚                   gateway (Node.js)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  src/wss/VultrClient.js (NEW)                            â”‚   â”‚
â”‚  â”‚       â†’ HELLO, HEARTBEAT, COMMAND ìˆ˜ì‹                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  src/adb/           (EXISTING)                           â”‚   â”‚
â”‚  â”‚  src/adapters/laixi/ (EXISTING)                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”˜
                         â”‚ USB/ADB
                         â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  S9 x20   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## í†µí•© ë°©ë²•

### 1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (.env)

```env
# Vultr ì—°ê²°
VULTR_ENABLED=true
VULTR_URL=ws://158.247.210.152:8000/ws/node
NODE_ID=node_runner_001
NODE_SECRET=bXlfc3VwZXJfc2VjcmV0X2tleV8xMjM0NTY=
```

### 2. index.js ìˆ˜ì •

```javascript
// index.js ìƒë‹¨ì— ì¶”ê°€
const { initVultrConnection, shutdownVultrConnection } = require('./vultr-integration');

// start() í•¨ìˆ˜ ë‚´, ADB ì´ˆê¸°í™” í›„ì— ì¶”ê°€
async function start() {
    // ... ê¸°ì¡´ ì´ˆê¸°í™” ì½”ë“œ ...
    
    // ADB í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” í›„
    await adbClient.initialize();
    
    // ===== Vultr ì—°ê²° ì¶”ê°€ =====
    const vultrClient = await initVultrConnection({
        adbClient,
        laixiAdapter: null, // ë˜ëŠ” laixiAdapter ì¸ìŠ¤í„´ìŠ¤
        logger,
        config
    });
    
    if (vultrClient) {
        logger.info('[Gateway] ğŸŒ Vultr ì—°ê²° í™œì„±í™”ë¨');
    }
    
    // ... ë‚˜ë¨¸ì§€ ì´ˆê¸°í™” ì½”ë“œ ...
}

// shutdown() í•¨ìˆ˜ì— ì¶”ê°€
async function shutdown(signal) {
    // ... ê¸°ì¡´ ì¢…ë£Œ ì½”ë“œ ...
    
    // Vultr ì—°ê²° ì¢…ë£Œ
    shutdownVultrConnection();
    
    // ...
}
```

### 3. ì»¤ìŠ¤í…€ ëª…ë ¹ í•¸ë“¤ëŸ¬ ì¶”ê°€ (ì„ íƒ)

```javascript
const { getCommandExecutor } = require('./vultr-integration');

// ì»¤ìŠ¤í…€ ëª…ë ¹ ë“±ë¡
const executor = getCommandExecutor();
if (executor) {
    executor.registerHandler('MY_CUSTOM_COMMAND', async (devices, params) => {
        // ì»¤ìŠ¤í…€ ë¡œì§
        return {
            status: 'SUCCESS',
            device_results: devices.map(d => ({
                slot: d.slot,
                serial: d.serial,
                status: 'SUCCESS'
            }))
        };
    });
}
```

## ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼

```
gateway/src/wss/
â”œâ”€â”€ index.js           # ëª¨ë“ˆ export
â”œâ”€â”€ VultrClient.js     # Vultr WSS í´ë¼ì´ì–¸íŠ¸
â””â”€â”€ CommandExecutor.js # COMMAND â†’ ADB/Laixi ì‹¤í–‰
```

## Protocol v1.0 ë©”ì‹œì§€ íë¦„

```
NodeRunner                              Vultr Server
    â”‚                                        â”‚
    â”‚ â‘  HELLO (node_id + signature)          â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
    â”‚                                        â”‚
    â”‚ â‘¡ HELLO_ACK (session_id)               â”‚
    â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚                                        â”‚
    â”‚ â‘¢ HEARTBEAT (30ì´ˆ ì£¼ê¸°)                 â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
    â”‚                                        â”‚
    â”‚ â‘£ COMMAND (Pull-based Push)            â”‚
    â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚                                        â”‚
    â”‚ â‘¤ RESULT                               â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
```

## Laixi ì—†ì´ ì‚¬ìš©

Laixiê°€ ì—†ì–´ë„ ì§ì ‘ ADBë¡œ ë™ì‘í•©ë‹ˆë‹¤:

```javascript
await initVultrConnection({
    adbClient,
    laixiAdapter: null,  // â† null ë˜ëŠ” ìƒëµ
    logger,
    config
});
```

CommandExecutorê°€ ìë™ìœ¼ë¡œ ADB fallback ì‚¬ìš©:
- Laixi ì—°ê²°ë¨ â†’ `laixiAdapter.tap()`, `laixiAdapter.swipe()`
- Laixi ì—†ìŒ â†’ `adbClient.shell('input tap ...')`

## ë¬¸ì œ í•´ê²°

### ì—°ê²° ì•ˆë¨

```bash
# Vultr ì„œë²„ í™•ì¸
curl http://158.247.210.152:8000/health

# í™˜ê²½ ë³€ìˆ˜ í™•ì¸
echo $VULTR_URL
echo $NODE_ID
```

### ëª…ë ¹ ì‹¤í–‰ ì•ˆë¨

```bash
# ADB ì—°ê²° í™•ì¸
adb devices

# ë””ë°”ì´ìŠ¤ ìƒíƒœ í™•ì¸
curl http://localhost:3100/api/devices
```

