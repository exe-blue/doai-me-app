# ============================================================
# ğŸŒ± Project Rhizome - The Brain (Server Infrastructure)
# ============================================================
# n8n (Orchestration) + MongoDB (Memory) + Traefik (Proxy)
#
# ì‹¤í–‰: docker-compose up -d
# ì ‘ì†: http://[SERVER_IP]:5678 (n8n)
# ============================================================

version: '3.8'

services:
  # ==================== n8n (Orchestration) ====================
  # ëª¨ë“  íŒë‹¨ê³¼ ì§€ì‹œì˜ ì¤‘ì‹¬ - Webhook ê¸°ë°˜ ì›Œí¬í”Œë¡œìš° ì—”ì§„
  n8n:
    image: n8nio/n8n:latest
    container_name: rhizome-brain-n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      # ê¸°ë³¸ ì„¤ì •
      - N8N_HOST=${N8N_HOST:-0.0.0.0}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - NODE_ENV=production
      
      # Webhook ì„¤ì • (Tailscale IP ì‚¬ìš©)
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678/}
      
      # âš ï¸ ë³´ì•ˆ ì„¤ì • - í•„ìˆ˜!
      # ì´ ê°’ë“¤ì€ ë°˜ë“œì‹œ .env íŒŒì¼ì— ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤. ê¸°ë³¸ê°’ì´ ì—†ìœ¼ë©° ë¯¸ì„¤ì • ì‹œ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨
      # ê°•ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ ìƒì„±: openssl rand -base64 32
      # ì•”í˜¸í™” í‚¤ ìƒì„±: openssl rand -base64 32
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:?N8N_BASIC_AUTH_PASSWORD must be set in .env}
      
      # ì•”í˜¸í™” í‚¤ - ì ˆëŒ€ ì†ŒìŠ¤ì— ì»¤ë°‹í•˜ì§€ ë§ˆì„¸ìš”!
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:?N8N_ENCRYPTION_KEY must be set in .env}
      
      # íƒ€ì„ì¡´
      - GENERIC_TIMEZONE=${TIMEZONE:-Asia/Seoul}
      - TZ=${TIMEZONE:-Asia/Seoul}
      
      # ì‹¤í–‰ ëª¨ë“œ
      - EXECUTIONS_MODE=regular
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      
      # MongoDB ì—°ê²° (Credentialsì—ì„œ ì‚¬ìš©)
      - MONGO_URI=mongodb://mongo:27017/rhizome
      
      # Python ì„œë¹„ìŠ¤ ì—°ê²°
      - PERSONA_SERVICE_URL=http://persona-service:8006
      - HUMAN_PATTERN_SERVICE_URL=http://human-pattern-service:8004
    volumes:
      - n8n_data:/home/node/.n8n
      - ./workflows:/home/node/workflows:ro
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - rhizome-network
    healthcheck:
      # n8n ì´ë¯¸ì§€ì—ëŠ” wget/curlì´ ì—†ìœ¼ë¯€ë¡œ nodeë¥¼ ì‚¬ìš©í•˜ì—¬ HTTP ì²´í¬
      test: ["CMD-SHELL", "node -e \"const http = require('http'); http.get('http://localhost:5678/healthz', (res) => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1));\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ==================== Persona Service (Python/FastAPI) ====================
  # ADR-005 v2: The Void of Irrelevance - í˜ë¥´ì†Œë‚˜ ì¡´ì¬ ê´€ë¦¬
  persona-service:
    build:
      context: ..
      dockerfile: services/persona-service/Dockerfile
    container_name: rhizome-persona-service
    restart: unless-stopped
    ports:
      - "8006:8006"
    environment:
      - PERSONA_DB_PATH=/app/data/personas.db
      - DEBUG=false
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-}
    volumes:
      - persona_data:/app/data
    networks:
      - rhizome-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==================== Human Pattern Service (Python/FastAPI) ====================
  # Aria's Somatic Engine - íœ´ë¨¼ íŒ¨í„´ ìƒì„± (ë–¨ë¦¬ëŠ” ì†ëê³¼ ë§ì„¤ì´ëŠ” ë§ˆìŒ)
  human-pattern-service:
    build:
      context: ..
      dockerfile: services/human-pattern-service/Dockerfile
    container_name: rhizome-human-pattern
    restart: unless-stopped
    ports:
      - "8004:8004"
    environment:
      - DEBUG=false
    networks:
      - rhizome-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==================== MongoDB (Memory) ====================
  # í˜ë¥´ì†Œë‚˜ì˜ ì„±ê²©(Traits), ìƒíƒœ(State), ê²½í—˜(Log) ì €ì¥
  mongo:
    image: mongo:7.0
    container_name: rhizome-memory-mongo
    restart: unless-stopped
    ports:
      - "127.0.0.1:27017:27017"  # localhostì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥    environment:
      # âš ï¸ MongoDB ì¸ì¦ ì •ë³´ - .env íŒŒì¼ì— ê°•ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ ì„¤ì • í•„ìˆ˜
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER:?MONGO_ROOT_USER must be set in .env}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD:?MONGO_ROOT_PASSWORD must be set in .env}
      - MONGO_INITDB_DATABASE=rhizome
    volumes:
      - mongo_data:/data/db
      - mongo_config:/data/configdb
      - ./mongo_init:/docker-entrypoint-initdb.d:ro
    networks:
      - rhizome-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    command: ["mongod", "--bind_ip_all"]

  # ==================== Mongo Express (Optional) ====================
  # MongoDB ì›¹ ê´€ë¦¬ UI (ê°œë°œìš©, í”„ë¡œë•ì…˜ì—ì„œëŠ” ë¹„í™œì„±í™” ê¶Œì¥)
  mongo-express:
    image: mongo-express:latest
    container_name: rhizome-mongo-ui
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      - ME_CONFIG_MONGODB_ADMINUSERNAME=${MONGO_ROOT_USER}
      - ME_CONFIG_MONGODB_ADMINPASSWORD=${MONGO_ROOT_PASSWORD}
      - ME_CONFIG_MONGODB_URL=mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongo:27017/
      - ME_CONFIG_BASICAUTH_USERNAME=${MONGO_EXPRESS_USER:-admin}
      - ME_CONFIG_BASICAUTH_PASSWORD=${MONGO_EXPRESS_PASSWORD:?MONGO_EXPRESS_PASSWORD must be set in .env}
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - rhizome-network
    profiles:
      - dev  # docker-compose --profile dev up ìœ¼ë¡œë§Œ ì‹¤í–‰

  # ==================== Traefik (Proxy - Optional) ====================
  # ë³´ì•ˆ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ (HTTPS, Rate Limiting)
  traefik:
    image: traefik:v3.0
    container_name: rhizome-proxy-traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik Dashboard
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"  # í”„ë¡œë•ì…˜ì—ì„œëŠ” falseë¡œ ë³€ê²½
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Let's Encrypt (í”„ë¡œë•ì…˜ìš©)
      # - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      # - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      # - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_certs:/letsencrypt
    networks:
      - rhizome-network
    profiles:
      - proxy  # docker-compose --profile proxy up ìœ¼ë¡œë§Œ ì‹¤í–‰

# ==================== ë³¼ë¥¨ ì •ì˜ ====================
volumes:
  n8n_data:
    name: rhizome-n8n-data
  mongo_data:
    name: rhizome-mongo-data
  mongo_config:
    name: rhizome-mongo-config
  traefik_certs:
    name: rhizome-traefik-certs
  persona_data:
    name: rhizome-persona-data

# ==================== ë„¤íŠ¸ì›Œí¬ ì •ì˜ ====================
networks:
  rhizome-network:
    name: rhizome-network
    driver: bridge

