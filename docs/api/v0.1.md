# API 명세 v0.1 (MVP 기준)

> 구현/운영/디버깅에 바로 쓰는 REST API 명세. 포맷: REST + JSON.

---

## 공통

### 인증

| 구분 | 방식 | 실패 |
|------|------|------|
| **Node 전용** | Header `X-Node-Auth: NODE_SHARED_SECRET` | 401 UNAUTHORIZED |
| **Admin(UI)** | MVP: 서버에서만 Supabase service role (클라 직접 접근 X). 추후 Supabase Auth/JWT 전환 |

### 응답 공통

- 모든 응답 헤더: `X-Request-Id: <uuid>`
- 성공 시 바디에 `request_id` 포함 가능

### 에러 응답 바디

```json
{
  "error": {
    "code": "VALIDATION_ERROR|UNAUTHORIZED|FORBIDDEN|NOT_FOUND|CONFLICT|LEASE_MISMATCH|DUPLICATE_EVENT|RATE_LIMITED|INTERNAL",
    "message": "human readable",
    "details": {}
  },
  "request_id": "uuid"
}
```

### 표준 에러 코드 (v0.1)

| code | HTTP | 설명 |
|------|------|------|
| VALIDATION_ERROR | 422 | 필드 누락/타입 오류/허용값 위반 |
| UNAUTHORIZED | 401 | 인증 실패 |
| FORBIDDEN | 403 | 권한 부족 (추후) |
| NOT_FOUND | 404 | 리소스 없음 |
| CONFLICT | 409 | 상태 충돌 (예: 이미 stopped) |
| LEASE_MISMATCH | 409 | lease_token 불일치 |
| DUPLICATE_EVENT | (내부적으로 200 duplicate 처리, 로그용) | |
| RATE_LIMITED | 429 | 과도 호출. 헤더 `Retry-After: <seconds>` |
| INTERNAL | 500 | 서버 오류 |

---

## 1) Dashboard

### GET /api/dashboard

**Query:** `window` (default `24h`, allowed: `1h` | `6h` | `24h`)

**Response 200**

```json
{
  "request_id": "uuid",
  "window": "24h",
  "kpis": {
    "runs_total": 0,
    "runs_running": 0,
    "runs_failed": 0,
    "devices_online": 0,
    "devices_offline": 0
  },
  "series": {
    "runs_per_hour": [{ "t": "ISO", "v": 3 }],
    "fails_per_hour": [{ "t": "ISO", "v": 1 }]
  },
  "mini_heatmap": {
    "slot": { "cols": 10, "rows": 10, "perNode": 100 },
    "nodes": [
      {
        "node_id": "PC-01",
        "label": "노드 1",
        "last_seen": "ISO",
        "counts": { "online": 82, "offline": 18 },
        "items": [{ "index": 1, "online": true, "last_seen": "ISO" }]
      }
    ]
  },
  "todo": [
    { "kind": "offline", "title": "현재 오프라인 18대", "href": "/devices?filter=offline" }
  ]
}
```

---

## 2) Nodes / Devices

### GET /api/nodes/status

**Query:** `node_id` (optional)

**Response 200**

```json
{
  "request_id": "uuid",
  "now": "ISO",
  "nodes": [
    {
      "node_id": "PC-01",
      "label": "노드 1",
      "runner_version": "0.1.0",
      "last_seen": "ISO",
      "counts": { "online": 82, "offline": 18 },
      "items": [
        { "index": 1, "online": true, "last_seen": "ISO", "last_error_message": null }
      ]
    }
  ]
}
```

### POST /api/nodes/heartbeat (권장)

**Headers:** `X-Node-Auth`

**Body**

```json
{
  "node_id": "PC-01",
  "runner_version": "0.1.0",
  "device_snapshot": [
    { "index": 57, "device_id": "onlySerial", "runtime_handle": "emulator-5554", "online": true, "last_seen": "ISO" }
  ]
}
```

**Response 200:** `{ "ok": true, "request_id": "uuid" }`  
**429 RATE_LIMITED (선택):** Header `Retry-After: 2`

---

## 3) Runs

### POST /api/runs

**Body**

```json
{
  "mode": "playbook",
  "title": "YouTube consume demo",
  "playbook_id": "uuid",
  "workflow_id": null,
  "params": { "QUERY": "sleep music" },
  "target": { "scope": "ALL", "node_id": null, "device_indexes": null },
  "defaults": { "online_window_sec": 30, "device_grace_wait_ms": 15000, "concurrency": 1 }
}
```

**Response 200:** `{ "request_id": "uuid", "run_id": "uuid", "status": "queued" }`  
**422 VALIDATION_ERROR:** playbook_id 없음, params 타입 오류 등

### GET /api/runs

**Query:** `window=24h` (default), `status` optional: `queued` | `running` | `succeeded` | `failed` | `stopped`

**Response 200**

```json
{
  "request_id": "uuid",
  "items": [
    {
      "run_id": "uuid",
      "title": "demo",
      "status": "running",
      "created_at": "ISO",
      "counts": { "running": 1, "done": 10, "error": 2, "skipped_offline": 3 }
    }
  ]
}
```

### GET /api/runs/:runId

**Query:** `selected` (device index, optional), `tail` (default 50, optional)

**Response 200**

```json
{
  "request_id": "uuid",
  "run": { "run_id": "uuid", "title": "demo", "status": "running" },
  "heatmap": {
    "items": [
      { "index": 1, "online": true, "activity": "running", "progress": { "current": 3, "total": 24 }, "last_error_message": null }
    ]
  },
  "selected": {
    "device_index": 1,
    "step": { "step_index": 3, "step_id": "yt_search", "status": "running" },
    "logs_tail": ["[10:10:01] step start"],
    "last_artifacts": [{ "kind": "screenshot", "url": "https://..." }]
  }
}
```

### POST /api/runs/:runId/stop

**Body:** `{ "reason": "operator_stop" }`  
**Response 200:** `{ "ok": true, "request_id": "uuid" }`

### GET /api/runs/:runId/logs (분리형, 권장)

**Query:** `device=57`, `tail=200`  
**Response 200:** `{ "request_id": "uuid", "device_index": 57, "tail": 200, "lines": ["..."] }`

---

## 4) Playbooks / Command Assets / Catalogs

### POST /api/playbooks

**Body:** `{ "title": "demo_20steps_v1_youtube", "steps": [ { "id": "base", "type": "ref", "ref": "adb_disable_animations" } ] }`  
**Response 200:** `{ "request_id": "uuid", "playbook_id": "uuid" }`

### GET /api/playbooks/:id

**Response 200:** playbook JSON

### GET /api/command-assets

**Query:** `folder`, `type`, `q`  
**Response 200**

```json
{
  "request_id": "uuid",
  "items": [
    { "id": "uuid", "type": "adb_script", "title": "애니메이션 0x", "folder": "10_device_baseline", "default_timeout_ms": 12000 }
  ]
}
```

### POST /api/command-assets/upload

- **Content-Type:** multipart/form-data: `file`, `metadata` (JSON)
- 저장: Storage `command-assets/...`; DB row: `command_assets`

**Response 200:** `{ "request_id": "uuid", "asset_id": "uuid", "storage_path": "command-assets/..." }`

### GET /api/catalogs (읽기 전용)

**Response 200:** `{ "request_id": "uuid", "items": [{ "catalog_id": "youtube_dom_actions_v1", "domain": "youtube_web", "version": 1 }] }`

### GET /api/catalogs/:catalogId

**Response 200:** catalog JSON

---

## 5) Node Protocol (코어)

### POST /api/nodes/pull

**Headers:** `X-Node-Auth`  
**Body:** `{ "node_id": "PC-01", "max_jobs": 1 }`

**Response 200**

```json
{
  "request_id": "uuid",
  "now": "ISO",
  "jobs": [
    {
      "job_id": "run-uuid:57:step12",
      "lease": { "owner": "PC-01", "until": "ISO", "token": "uuid" },
      "run": { "run_id": "uuid", "params": { "QUERY": "sleep music" }, "defaults": { "device_grace_wait_ms": 15000 } },
      "device": { "index": 57, "runtime_handle": "emulator-5554" },
      "step": { "step_index": 12, "step_id": "open-comments", "step_type": "adb_script", "payload": { "adb_script": "..." } },
      "execution": { "decision": "executed|skipped" }
    }
  ]
}
```

- **204 No Content (선택):** jobs 없을 때 204 가능 (200 + `jobs: []` 도 OK)
- **429 RATE_LIMITED (선택):** `Retry-After: 2`

### POST /api/nodes/callback

**Headers:** `X-Node-Auth`  
**Body (run_step_update 예시)**

```json
{
  "event_id": "uuid",
  "type": "run_step_update",
  "node_id": "PC-01",
  "payload": {
    "run_id": "uuid",
    "device_index": 57,
    "lease_token": "uuid",
    "step": {
      "step_index": 12,
      "step_id": "open-comments",
      "status": "running|succeeded|failed|skipped",
      "error_message": null
    },
    "log_line": "[10:10:01] step start"
  }
}
```

**Response 200 (신규):** `{ "ok": true, "duplicate": false, "request_id": "uuid" }`  
**Response 200 (멱등 중복):** `{ "ok": true, "duplicate": true, "request_id": "uuid" }`  
**Response 409 LEASE_MISMATCH**

```json
{
  "error": {
    "code": "LEASE_MISMATCH",
    "message": "lease_token does not match current lease",
    "details": { "run_id": "uuid", "device_index": 57 }
  },
  "request_id": "uuid"
}
```

---

## v0.1이 보장하는 것

- 노드 재시도/중복 송신에도 안전 (멱등)
- 늦은 콜백이 최신 상태를 덮어쓰지 못함 (lease_token)
- 운영자 장애 추적 가능 (request_id / job_id)

---

## 참고

- 계약 상세(콜백 6종): [../spec/callback-contract.md](../spec/callback-contract.md)
- Node 프로토콜만: [../contracts/node-protocol.md](../contracts/node-protocol.md)
- 갭 리스트: [../qa/gap-list-pages-vs-apis.md](../qa/gap-list-pages-vs-apis.md)
