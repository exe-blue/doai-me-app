# ============================================
# DoAi.Me CI/CD Pipeline
# ============================================
# Triggers:
#   - Push to main branch
#   - Manual dispatch
#
# Jobs:
#   1. Deploy to Vultr (Docker services)
#   2. Vercel auto-deploys via GitHub integration
# ============================================

name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_vultr:
        description: 'Deploy to Vultr'
        required: false
        default: 'true'
        type: boolean

env:
  VULTR_HOST: ${{ secrets.VULTR_HOST }}
  VULTR_USER: ${{ secrets.VULTR_USER }}
  VULTR_SSH_KEY: ${{ secrets.VULTR_SSH_KEY }}

jobs:
  # ==================== Vultr Deployment ====================
  deploy-vultr:
    name: Deploy to Vultr
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.deploy_vultr == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VULTR_SSH_KEY }}

      - name: Add Vultr to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VULTR_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Vultr
        run: |
          ssh ${{ secrets.VULTR_USER }}@${{ secrets.VULTR_HOST }} << 'ENDSSH'
            set -e
            
            echo "=========================================="
            echo "ğŸš€ DoAi.Me Vultr ë°°í¬ ì‹œì‘"
            echo "=========================================="
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /opt/aifarm || { echo "âŒ /opt/aifarm ë””ë ‰í† ë¦¬ ì—†ìŒ"; exit 1; }
            
            # Git pull
            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
            git fetch origin main
            git reset --hard origin/main
            
            # Docker Compose ì¬ì‹œì‘
            echo "ğŸ³ Docker ì„œë¹„ìŠ¤ ì¬ì‹œì‘..."
            cd Server_Vultr
            docker-compose pull
            docker-compose up -d --build --remove-orphans
            
            # í—¬ìŠ¤ì²´í¬
            echo "ğŸ” í—¬ìŠ¤ì²´í¬..."
            sleep 10
            
            # n8n ì²´í¬
            if curl -sf http://localhost:5678/healthz > /dev/null 2>&1; then
              echo "âœ… n8n: ì •ìƒ"
            else
              echo "âš ï¸ n8n: ì‹œì‘ ì¤‘..."
            fi
            
            # Persona Service ì²´í¬
            if curl -sf http://localhost:8006/health > /dev/null 2>&1; then
              echo "âœ… persona-service: ì •ìƒ"
            else
              echo "âš ï¸ persona-service: ì‹œì‘ ì¤‘..."
            fi
            
            # Human Pattern Service ì²´í¬
            if curl -sf http://localhost:8004/health > /dev/null 2>&1; then
              echo "âœ… human-pattern-service: ì •ìƒ"
            else
              echo "âš ï¸ human-pattern-service: ì‹œì‘ ì¤‘..."
            fi
            
            # ì„œë¹„ìŠ¤ ìƒíƒœ ì¶œë ¥
            echo ""
            echo "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ:"
            docker-compose ps
            
            echo ""
            echo "=========================================="
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "=========================================="
          ENDSSH

  # ==================== Notify ====================
  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-vultr]
    if: always()
    
    steps:
      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "ğŸ“‹ ë°°í¬ ìš”ì•½"
          echo "=========================================="
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo ""
          echo "Vultr: ${{ needs.deploy-vultr.result }}"
          echo "Vercel: Auto-deployed via GitHub integration"
          echo "=========================================="

