# Node Runner Windows exe → zip → GitHub Release
# Trigger: push tag v* (e.g. v0.1.0)
name: release-node-runner

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install root deps
        run: npm ci

      - name: Install node-agent deps
        working-directory: node-agent
        run: npm ci

      # Build node-agent (TypeScript → dist/). For exe: bundle to single file then pkg, or use node20 + pkg with CJS entry.
      - name: Build node-agent
        working-directory: node-agent
        run: npm run build

      # Build node-runner.exe (adapt to your runner: pkg dist/index.js, or esbuild bundle + pkg, or nexe)
      - name: Build node-runner.exe
        shell: pwsh
        run: |
          npm install -g pkg
          # ESM: pkg does not support ESM. Option A) add a CJS wrapper entry that imports dist. Option B) use esbuild to bundle to CJS then pkg.
          # Placeholder: copy dist/index.js as single entry; if ESM, replace with esbuild step + pkg the bundle.
          if (Test-Path node-agent/dist/index.js) {
            pkg -t node20-win-x64 -o dist/node-runner.exe node-agent/dist/index.js
          } else {
            Write-Warning "node-agent/dist/index.js not found; create a build step that produces a single CJS entry for pkg."
            New-Item -ItemType Directory -Force -Path dist | Out-Null
            # No exe produced - workflow will fail at next step unless you fix the build
          }
          if (-not (Test-Path dist/node-runner.exe)) { throw "dist/node-runner.exe not found" }

      # Download WinSW (no binary in repo)
      - name: Download WinSW
        shell: pwsh
        run: |
          $winswUrl = "https://github.com/winsw/winsw/releases/download/v2.12.0/WinSW-x64.exe"
          New-Item -ItemType Directory -Force -Path tools/winsw | Out-Null
          Invoke-WebRequest -Uri $winswUrl -OutFile tools/winsw/winsw.exe -UseBasicParsing

      - name: Prepare release folder
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart("v")
          $out = "release/node-runner-win-x64-v$ver"
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          Copy-Item -Force dist/node-runner.exe "$out/node-runner.exe"
          Copy-Item -Force tools/winsw/winsw.exe "$out/winsw.exe"
          Copy-Item -Force tools/winsw/node-runner-service.xml "$out/node-runner-service.xml"
          Copy-Item -Force tools/winsw/install.ps1 "$out/install.ps1"
          Copy-Item -Force tools/winsw/update.ps1 "$out/update.ps1"

      - name: Zip package
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart("v")
          $folder = "release/node-runner-win-x64-v$ver"
          $zip = "node-runner-win-x64-v$ver.zip"
          if (Test-Path $zip) { Remove-Item -Force $zip }
          Compress-Archive -Path "$folder/*" -DestinationPath $zip -Force

          $hash = (Get-FileHash -Algorithm SHA256 $zip).Hash.ToLower()
          "$hash  $zip" | Out-File -FilePath sha256sums.txt -Encoding ascii

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            node-runner-win-x64-v*.zip
            sha256sums.txt
          generate_release_notes: true
