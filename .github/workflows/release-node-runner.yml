# Node Runner Windows exe → zip → GitHub Release
# Trigger: push tag v* (e.g. v0.1.0)
name: release-node-runner

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install root deps
        run: npm ci

      - name: Install node-agent deps
        working-directory: node-agent
        run: npm ci

      # Build node-agent (tsup → dist-bundle/index.cjs single CJS file)
      - name: Build node-agent
        working-directory: node-agent
        run: npm run build

      # pkg: target node18 (not node20); input = CJS single bundle only → dist/node-runner.exe always
      - name: Build node-runner.exe
        shell: pwsh
        run: |
          npm install -g pkg
          $cjs = "node-agent/dist-bundle/index.cjs"
          if (-not (Test-Path $cjs)) { throw "CJS bundle not found: $cjs" }
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          pkg -t node18-win-x64 -o dist/node-runner.exe $cjs
          if (-not (Test-Path dist/node-runner.exe)) { throw "dist/node-runner.exe not found" }

      # Download WinSW (no binary in repo)
      - name: Download WinSW
        shell: pwsh
        run: |
          $winswUrl = "https://github.com/winsw/winsw/releases/download/v2.12.0/WinSW-x64.exe"
          New-Item -ItemType Directory -Force -Path tools/winsw | Out-Null
          Invoke-WebRequest -Uri $winswUrl -OutFile tools/winsw/winsw.exe -UseBasicParsing

      - name: Prepare release folder
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart("v")
          $out = "release/node-runner-win-x64-v$ver"
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          Copy-Item -Force dist/node-runner.exe "$out/node-runner.exe"
          Copy-Item -Force tools/winsw/winsw.exe "$out/winsw.exe"
          Copy-Item -Force tools/winsw/node-runner-service.xml "$out/node-runner-service.xml"
          Copy-Item -Force tools/winsw/install.ps1 "$out/install.ps1"
          Copy-Item -Force tools/winsw/update.ps1 "$out/update.ps1"
          Copy-Item -Force tools/winsw/node-runner-setup.iss "$out/node-runner-setup.iss"

      - name: Install Inno Setup
        shell: pwsh
        run: choco install innosetup -y

      - name: Build setup.exe
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart("v")
          $out = "release/node-runner-win-x64-v$ver"
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $iscc)) { throw "ISCC not found: $iscc" }
          & $iscc "/DMyAppVersion=$ver" "$out/node-runner-setup.iss"
          if (-not (Test-Path "$out/setup.exe")) { throw "setup.exe was not created" }

      - name: Verify setup.exe
        shell: pwsh
        run: |
          $ver = "${{ github.ref_name }}".TrimStart("v")
          $setup = "release/node-runner-win-x64-v$ver/setup.exe"
          if (-not (Test-Path $setup)) { throw "setup.exe missing: $setup" }
          $len = (Get-Item $setup).Length
          if ($len -lt 1MB) { throw "setup.exe too small ($len bytes), likely corrupt" }
          Write-Host "setup.exe OK, size $([math]::Round($len/1MB, 2)) MB"

      - name: Zip package
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart("v")
          $folder = "release/node-runner-win-x64-v$ver"
          $zip = "node-runner-win-x64-v$ver.zip"
          if (Test-Path $zip) { Remove-Item -Force $zip }
          Compress-Archive -Path "$folder/*" -DestinationPath $zip -Force

          $hashes = @()
          $hashes += (Get-FileHash -Algorithm SHA256 "dist/node-runner.exe").Hash.ToLower() + "  doai-node-runner-$ver-win-x64.exe"
          $hashes += (Get-FileHash -Algorithm SHA256 $zip).Hash.ToLower() + "  $zip"
          $hashes += (Get-FileHash -Algorithm SHA256 "$folder/setup.exe").Hash.ToLower() + "  node-runner-setup-v$ver.exe"
          $hashes -join "`n" | Out-File -FilePath sha256sums.txt -Encoding ascii

      - name: Rename setup.exe for release
        shell: pwsh
        run: |
          $ver = "${{ github.ref_name }}".TrimStart("v")
          $folder = "release/node-runner-win-x64-v$ver"
          Copy-Item -Force "$folder/setup.exe" "node-runner-setup-v$ver.exe"

      # Standalone exe for Releases: doai-node-runner-<ver>-win-x64.exe (required for every release)
      - name: Prepare doai-node-runner exe
        shell: pwsh
        run: |
          $ver = "${{ github.ref_name }}".TrimStart("v")
          Copy-Item -Force dist/node-runner.exe "doai-node-runner-$ver-win-x64.exe"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            doai-node-runner-*-win-x64.exe
            node-runner-win-x64-v*.zip
            node-runner-setup-v*.exe
            sha256sums.txt
          generate_release_notes: true
