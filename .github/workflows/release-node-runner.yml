# Node Runner Windows exe → zip → GitHub Release
# Trigger: push tag v* (e.g. v0.1.0)
# SonarQube: 이 워크플로에는 Sonar를 넣지 않음. 넣을 경우 해당 job은 continue-on-error: true로 EXE 업로드를 막지 않도록 할 것.
name: release-node-runner

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

# 고정 경로: 번들(CJS 단일) → pkg → dist/node-runner.exe. pkg@5.8.1은 node20 타겟 미지원이므로 Node 18 사용.
env:
  CJS_BUNDLE: node-agent/dist-bundle/index.cjs
  PKG_OUTPUT: dist/node-runner.exe

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Verify Node version
        shell: pwsh
        run: |
          $v = node -v
          if (-not $v.StartsWith("v18.")) { throw "Expected Node 18.x, got $v. pkg@5.8.1 does not support Node 20." }
          Write-Host "Node $v OK"

      - name: Install root deps
        run: npm ci

      - name: Install node-agent deps
        working-directory: node-agent
        run: npm ci

      # 1) tsup → 단일 CJS 번들 (고정 출력: node-agent/dist-bundle/index.cjs)
      - name: Build node-agent bundle
        working-directory: node-agent
        run: npm run build

      # 2) CJS 번들 존재 확인 후 pkg → exe (입력/출력 경로 고정)
      - name: Verify CJS bundle
        shell: pwsh
        run: |
          if (-not (Test-Path $env:CJS_BUNDLE)) { throw "CJS bundle not found: $env:CJS_BUNDLE" }
          Write-Host "Bundle OK: $env:CJS_BUNDLE"

      - name: Build node-runner.exe (pkg node18-win-x64)
        shell: pwsh
        run: |
          npm install -g pkg@5.8.1
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          pkg --targets node18-win-x64 --output $env:PKG_OUTPUT $env:CJS_BUNDLE
          if (-not (Test-Path $env:PKG_OUTPUT)) { throw "pkg output not found: $env:PKG_OUTPUT" }
          Write-Host "EXE OK: $env:PKG_OUTPUT"

      # Download WinSW (no binary in repo)
      - name: Download WinSW
        shell: pwsh
        run: |
          $winswUrl = "https://github.com/winsw/winsw/releases/download/v2.12.0/WinSW-x64.exe"
          New-Item -ItemType Directory -Force -Path tools/winsw | Out-Null
          Invoke-WebRequest -Uri $winswUrl -OutFile tools/winsw/winsw.exe -UseBasicParsing

      - name: Prepare release folder
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart("v")
          $out = "release/node-runner-win-x64-v$ver"
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          Copy-Item -Force dist/node-runner.exe "$out/node-runner.exe"
          Copy-Item -Force tools/winsw/winsw.exe "$out/winsw.exe"
          Copy-Item -Force tools/winsw/node-runner-service.xml "$out/node-runner-service.xml"
          Copy-Item -Force tools/winsw/install.ps1 "$out/install.ps1"
          Copy-Item -Force tools/winsw/update.ps1 "$out/update.ps1"
          Copy-Item -Force tools/winsw/node-runner-setup.iss "$out/node-runner-setup.iss"

      - name: Install Inno Setup
        shell: pwsh
        run: choco install innosetup -y

      - name: Build setup.exe
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart("v")
          $out = "release/node-runner-win-x64-v$ver"
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $iscc)) { throw "ISCC not found: $iscc" }
          & $iscc "/DMyAppVersion=$ver" "$out/node-runner-setup.iss"
          if (-not (Test-Path "$out/setup.exe")) { throw "setup.exe was not created" }

      - name: Verify setup.exe
        shell: pwsh
        run: |
          $ver = "${{ github.ref_name }}".TrimStart("v")
          $setup = "release/node-runner-win-x64-v$ver/setup.exe"
          if (-not (Test-Path $setup)) { throw "setup.exe missing: $setup" }
          $len = (Get-Item $setup).Length
          if ($len -lt 1MB) { throw "setup.exe too small ($len bytes), likely corrupt" }
          Write-Host "setup.exe OK, size $([math]::Round($len/1MB, 2)) MB"

      - name: Zip package
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart("v")
          $folder = "release/node-runner-win-x64-v$ver"
          $zip = "node-runner-win-x64-v$ver.zip"
          if (Test-Path $zip) { Remove-Item -Force $zip }
          Compress-Archive -Path "$folder/*" -DestinationPath $zip -Force

          $hashes = @()
          $hashes += (Get-FileHash -Algorithm SHA256 "dist/node-runner.exe").Hash.ToLower() + "  doai-node-runner-$ver-win-x64.exe"
          $hashes += (Get-FileHash -Algorithm SHA256 $zip).Hash.ToLower() + "  $zip"
          $hashes += (Get-FileHash -Algorithm SHA256 "$folder/setup.exe").Hash.ToLower() + "  node-runner-setup-v$ver.exe"
          $hashes -join "`n" | Out-File -FilePath sha256sums.txt -Encoding ascii

      - name: Rename setup.exe for release
        shell: pwsh
        run: |
          $ver = "${{ github.ref_name }}".TrimStart("v")
          $folder = "release/node-runner-win-x64-v$ver"
          Copy-Item -Force "$folder/setup.exe" "node-runner-setup-v$ver.exe"

      # Standalone exe for Releases: doai-node-runner-<ver>-win-x64.exe (required for every release)
      - name: Prepare doai-node-runner exe
        shell: pwsh
        run: |
          $ver = "${{ github.ref_name }}".TrimStart("v")
          Copy-Item -Force dist/node-runner.exe "doai-node-runner-$ver-win-x64.exe"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            doai-node-runner-*-win-x64.exe
            node-runner-win-x64-v*.zip
            node-runner-setup-v*.exe
            sha256sums.txt
          generate_release_notes: true
