# Node Runner Windows installer → GitHub Release
# Trigger: push tag v* only (e.g. git tag v0.1.0 && git push origin v0.1.0). main 머지는 릴리즈 생성 금지.
# 산출물 규격(고정): release/node-runner-win-x64-${TAG}/Output/doai-me-app-${VERSION}-win-x64-installer.exe (리포명+버전+installer)
# 릴리즈 성공 = 해당 EXE asset이 GitHub Releases에 존재.
name: release-node-runner

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

# 고정 경로: 번들 → pkg → dist/node-runner.exe. Inno → .../Output/doai-me-app-<ver>-win-x64-installer.exe
env:
  CJS_BUNDLE: node-agent/dist-bundle/index.cjs
  PKG_OUTPUT: dist/node-runner.exe

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Verify Node version
        shell: pwsh
        run: |
          $v = node -v
          if (-not $v.StartsWith("v18.")) { throw "Expected Node 18.x, got $v. pkg@5.8.1 does not support Node 20." }
          Write-Host "Node $v OK"

      - name: Install root deps
        run: npm ci

      - name: Install node-agent deps
        working-directory: node-agent
        run: npm ci

      # 1) tsup → 단일 CJS 번들 (고정 출력: node-agent/dist-bundle/index.cjs)
      - name: Build node-agent bundle
        working-directory: node-agent
        run: npm run build

      # 2) CJS 번들 존재 확인 후 pkg → exe (입력/출력 경로 고정)
      - name: Verify CJS bundle
        shell: pwsh
        run: |
          if (-not (Test-Path $env:CJS_BUNDLE)) { throw "CJS bundle not found: $env:CJS_BUNDLE" }
          Write-Host "Bundle OK: $env:CJS_BUNDLE"

      # Tray (systray): embed traybin so --tray can spawn tray_windows_release.exe
      - name: Copy systray traybin for pkg assets
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path node-agent/traybin | Out-Null
          Copy-Item -Force node-agent/node_modules/systray/traybin/tray_windows_release.exe node-agent/traybin/

      - name: Build node-runner.exe (pkg node18-win-x64)
        shell: pwsh
        run: |
          npm install -g pkg@5.8.1
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          pkg --targets node18-win-x64 --output $env:PKG_OUTPUT --config node-agent/pkg-config.json $env:CJS_BUNDLE
          if (-not (Test-Path $env:PKG_OUTPUT)) { throw "pkg output not found: $env:PKG_OUTPUT" }
          Write-Host "EXE OK: $env:PKG_OUTPUT"

      # Download WinSW (no binary in repo)
      - name: Download WinSW
        shell: pwsh
        run: |
          $winswUrl = "https://github.com/winsw/winsw/releases/download/v2.12.0/WinSW-x64.exe"
          New-Item -ItemType Directory -Force -Path tools/winsw | Out-Null
          Invoke-WebRequest -Uri $winswUrl -OutFile tools/winsw/winsw.exe -UseBasicParsing

      # 빌드 산출물 디렉터리: release/node-runner-win-x64-${TAG}/ (TAG = v0.1.0)
      - name: Prepare release folder
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart("v")
          $out = "release/node-runner-win-x64-$tag"
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          Copy-Item -Force dist/node-runner.exe "$out/node-runner.exe"
          Copy-Item -Force tools/winsw/winsw.exe "$out/winsw.exe"
          Copy-Item -Force tools/winsw/node-runner-service.xml "$out/node-runner-service.xml"
          Copy-Item -Force tools/winsw/install.ps1 "$out/install.ps1"
          Copy-Item -Force tools/winsw/update.ps1 "$out/update.ps1"
          Copy-Item -Force tools/winsw/node-runner-setup.iss "$out/node-runner-setup.iss"

      - name: Install Inno Setup
        shell: pwsh
        run: choco install innosetup -y

      # 산출물 규격: release/node-runner-win-x64-${TAG}/Output/doai-node-runner-${VERSION}-win-x64-installer.exe (고정)
      - name: Build installer (Inno Setup → Output/)
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart("v")
          $out = "release/node-runner-win-x64-$tag"
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $iscc)) { throw "ISCC not found: $iscc" }
          & $iscc "/DMyAppVersion=$ver" "$out/node-runner-setup.iss"
          $installer = "$out/Output/doai-me-app-$ver-win-x64-installer.exe"
          if (-not (Test-Path $installer)) { throw "Installer was not created: $installer" }
          Write-Host "Installer OK: $installer"

      # 생성 확인(Test-Path): 정확한 경로 1개만 검사. Output 폴더 누락 시 즉시 실패.
      - name: Verify installer path
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart("v")
          $installer = "release/node-runner-win-x64-$tag/Output/doai-me-app-$ver-win-x64-installer.exe"
          if (-not (Test-Path $installer)) { throw "Installer missing: $installer" }
          $len = (Get-Item $installer).Length
          if ($len -lt 1MB) { throw "Installer too small ($len bytes), likely corrupt" }
          Write-Host "Installer OK, size $([math]::Round($len/1MB, 2)) MB"

      # 체크섬 (선택): sha256sums.txt
      - name: Create sha256sums.txt
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart("v")
          $installer = "release/node-runner-win-x64-$tag/Output/doai-me-app-$ver-win-x64-installer.exe"
          $hash = (Get-FileHash -Algorithm SHA256 $installer).Hash.ToLower()
          "$hash  doai-me-app-$ver-win-x64-installer.exe" | Out-File -FilePath sha256sums.txt -Encoding ascii

      # Release 업로드: MVP는 이 파일 1개 필수. sha256sums.txt 선택 포함.
      - name: Copy assets for release upload
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart("v")
          $src = "release/node-runner-win-x64-$tag/Output/doai-me-app-$ver-win-x64-installer.exe"
          Copy-Item -Force $src "doai-me-app-$ver-win-x64-installer.exe"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            doai-me-app-*-win-x64-installer.exe
            sha256sums.txt
          body_path: .github/release-notes-node-runner.md
          generate_release_notes: false
