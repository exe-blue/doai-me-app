# π€ λ΅μ»¬ μ‹¤ν–‰ κ°€μ΄λ“

μ „μ²΄ μ‹μ¤ν…μ„ λ΅μ»¬μ—μ„ ν…μ¤νΈν•λ” λ°©λ²•μ…λ‹λ‹¤.

## μ•„ν‚¤ν…μ²

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚  Frontend (apps/web)                                            β”‚
β”‚  http://localhost:3000/admin/command                            β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                             β”‚ HTTP
                             β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚  Cloud Gateway (services/cloud-gateway)                         β”‚
β”‚  http://localhost:8000                                          β”‚
β”‚  β– /api/command - λ…λ Ή μ „μ†΅                                     β”‚
β”‚  β– /api/nodes - λ…Έλ“ λ©λ΅                                       β”‚
β”‚  β– /ws/node - WebSocket μ—°κ²°                                    β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                             β”‚ WebSocket
                             β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚  Local Gateway (local/gateway)                                  β”‚
β”‚  http://localhost:3100                                          β”‚
β”‚  β– ADB λ””λ°”μ΄μ¤ μ μ–΄                                            β”‚
β”‚  β– Laixi μ—°κ²° (μ„ νƒ)                                            β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                             β”‚ USB/ADB
                             β–Ό
                    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                    β”‚  Android Device β”‚
                    β”‚  (S9, etc.)     β”‚
                    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

---

## Step 1: Cloud Gateway μ‹¤ν–‰

### μµμ… A: Vultr μ„λ²„ μ‚¬μ© (κ¶μ¥)
μ΄λ―Έ Vultrμ—μ„ μ‹¤ν–‰ μ¤‘μ΄λΌλ©΄ μ΄ λ‹¨κ³„λ¥Ό κ±΄λ„λ›°μ„Έμ”.

```bash
# μ„λ²„ μƒνƒ ν™•μΈ
curl http://158.247.210.152:8000/health
```

### μµμ… B: λ΅μ»¬μ—μ„ μ‹¤ν–‰

```bash
cd services/cloud-gateway

# κ°€μƒν™κ²½ μƒμ„± λ° ν™μ„±ν™”
python -m venv venv
# Windows
.\venv\Scripts\activate
# Linux/Mac
source venv/bin/activate

# μμ΅΄μ„± μ„¤μΉ
pip install -r requirements.txt

# μ‹¤ν–‰
python main.py
```

**κ²°κ³Ό:**
```
INFO:     Uvicorn running on http://0.0.0.0:8000
```

---

## Step 2: Local Gateway μ‹¤ν–‰

```bash
cd local/gateway

# ν™κ²½ λ³€μ μ„¤μ •
cp config.example.env .env

# .env νΈμ§‘ (μ¤‘μ”!)
# λ΅μ»¬μ—μ„ cloud-gateway μ‹¤ν–‰ μ‹:
#   VULTR_URL=ws://localhost:8000/ws/node
# Vultr μ„λ²„ μ‚¬μ© μ‹:
#   VULTR_URL=ws://158.247.210.152:8000/ws/node

# μμ΅΄μ„± μ„¤μΉ
npm install

# μ‹¤ν–‰
npm start
```

**κ²°κ³Ό:**
```
β•”β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•—
β•‘                                                           β•‘
β•‘   π‰ DoAi-Gateway v2.0                                    β•‘
β•‘   Dynamic Device Discovery + WebSocket Multiplexing       β•‘
β•‘                                                           β•‘
β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•
[Gateway] ADB μ„λ²„ μ΄κΈ°ν™”...
[Gateway] β… ADB μ„λ²„ μ¤€λΉ„
[Vultr] β… μ—°κ²°λ¨ (session=abc123)
```

---

## Step 3: Frontend μ‹¤ν–‰

```bash
cd apps/web

# ν™κ²½ λ³€μ μ„¤μ •
echo "NEXT_PUBLIC_GATEWAY_URL=http://localhost:8000" > .env.local
# λλ” Vultr μ‚¬μ© μ‹:
# echo "NEXT_PUBLIC_GATEWAY_URL=http://158.247.210.152:8000" > .env.local

# μμ΅΄μ„± μ„¤μΉ
npm install

# κ°λ° μ„λ²„ μ‹¤ν–‰
npm run dev
```

**κ²°κ³Ό:**
```
β–² Next.js 14.x.x
- Local:        http://localhost:3000
```

---

## Step 4: ν…μ¤νΈ

### 4.1 λΈλΌμ°μ €μ—μ„ ν™•μΈ

1. http://localhost:3000/admin/command μ ‘μ†
2. μ—°κ²°λ λ…Έλ“κ°€ ν‘μ‹λλ”μ§€ ν™•μΈ
3. λ…λ Ή μ ν• μ„ νƒ ν›„ "β΅ λ…λ Ή μ „μ†΅" ν΄λ¦­

### 4.2 APIλ΅ μ§μ ‘ ν…μ¤νΈ

```bash
# λ…Έλ“ λ©λ΅ ν™•μΈ
curl http://localhost:8000/api/nodes

# λ…λ Ή μ „μ†΅
curl -X POST http://localhost:8000/api/command \
  -H "Content-Type: application/json" \
  -d '{
    "node_id": "node_local_001",
    "action": "SYNC_STATE",
    "device_id": "all",
    "params": {},
    "timeout": 60
  }'
```

---

## ADB λ””λ°”μ΄μ¤ μ—†μ΄ ν…μ¤νΈ

μ‹¤μ  λ””λ°”μ΄μ¤ μ—†μ΄ ν…μ¤νΈν•λ ¤λ©΄ Gatewayλ¥Ό Mock λ¨λ“λ΅ μ‹¤ν–‰:

```bash
# local/gateway/.env
MOCK_DEVICES=true
MOCK_DEVICE_COUNT=5
```

λλ” Android Emulator μ‚¬μ©:

```bash
# Android Studio Emulator μ‹¤ν–‰ ν›„
adb devices
# κ²°κ³Ό: emulator-5554 device
```

---

## λ¬Έμ  ν•΄κ²°

### "μ—°κ²°λ λ…Έλ“κ°€ μ—†μµλ‹λ‹¤"

1. Cloud Gateway μ‹¤ν–‰ ν™•μΈ:
   ```bash
   curl http://localhost:8000/health
   ```

2. Gateway λ΅κ·Έ ν™•μΈ:
   ```bash
   # local/gateway ν„°λ―Έλ„μ—μ„
   [Vultr] β… μ—°κ²°λ¨
   ```

3. ν™κ²½ λ³€μ ν™•μΈ:
   ```bash
   # local/gateway/.env
   VULTR_ENABLED=true
   VULTR_URL=ws://localhost:8000/ws/node
   ```

### "ADB μ—°κ²° μ‹¤ν¨"

```bash
# ADB μ„λ²„ μ¬μ‹μ‘
adb kill-server
adb start-server
adb devices
```

### "CORS μ—λ¬"

Cloud Gatewayμ CORS μ„¤μ • ν™•μΈ:
```python
# services/cloud-gateway/main.py
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # λλ” νΉμ • λ„λ©”μΈ
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

## λ…λ Ή μ ν•

| λ…λ Ή | μ„¤λ… | νλΌλ―Έν„° μμ‹ |
|------|------|---------------|
| `WATCH_VIDEO` | νΉμ • μμƒ μ‹μ²­ | `{"video_url": "https://..."}` |
| `RANDOM_WATCH` | λλ¤ μμƒ μ‹μ²­ | `{}` |
| `LIKE_VIDEO` | ν„μ¬ μμƒ μΆ‹μ•„μ” | `{}` |
| `RESTART_DEVICE` | λ””λ°”μ΄μ¤ μ¬λ¶€ν… | `{}` |
| `SYNC_STATE` | μƒνƒ λ™κΈ°ν™” | `{}` |

---

## μ „μ²΄ νλ¦„ λ‹¤μ΄μ–΄κ·Έλ¨

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚                        USER ACTION                               β”‚
β”‚                                                                  β”‚
β”‚   Browser β†’ /admin/command β†’ "β΅ λ…λ Ή μ „μ†΅" ν΄λ¦­                  β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                               β”‚
                               β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚                       1. HTTP POST                               β”‚
β”‚                                                                  β”‚
β”‚   POST /api/command                                              β”‚
β”‚   {                                                              β”‚
β”‚     "node_id": "node_local_001",                                 β”‚
β”‚     "action": "RANDOM_WATCH",                                    β”‚
β”‚     "device_id": "all"                                           β”‚
β”‚   }                                                              β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                               β”‚
                               β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚                    2. Cloud Gateway                              β”‚
β”‚                                                                  β”‚
β”‚   - λ…Έλ“ μ—°κ²° ν™•μΈ                                                β”‚
β”‚   - COMMAND λ©”μ‹μ§€ λΉλ“                                          β”‚
β”‚   - WebSocketμΌλ΅ λ…Έλ“μ— μ „μ†΅                                     β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                               β”‚ WSS COMMAND
                               β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚                      3. Local Gateway                            β”‚
β”‚                                                                  β”‚
β”‚   VultrClient._handleCommand()                                   β”‚
β”‚   β†’ CommandExecutor.execute()                                    β”‚
β”‚   β†’ ADB shell λ…λ Ή μ‹¤ν–‰                                          β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                               β”‚ ADB
                               β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚                     4. Android Device                            β”‚
β”‚                                                                  β”‚
β”‚   - YouTube μ•± μ‹¤ν–‰                                               β”‚
β”‚   - μμƒ μ¬μƒ                                                     β”‚
β”‚   - μΆ‹μ•„μ” λ“±                                                     β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                               β”‚
                               β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚                      5. RESULT λ°ν™                              β”‚
β”‚                                                                  β”‚
β”‚   Device β†’ Gateway β†’ Cloud Gateway β†’ Frontend                    β”‚
β”‚                                                                  β”‚
β”‚   κ²°κ³Ό: β… μ„±κ³µ (5/5 devices)                                     β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

---

## Laixi μ„¤μ • (μµμ…)

Laixiλ¥Ό μ‚¬μ©ν•λ©΄ AutoX.js μ¤ν¬λ¦½νΈλ΅ λ” μ •κµν• λ””λ°”μ΄μ¤ μ μ–΄κ°€ κ°€λ¥ν•©λ‹λ‹¤.

### Laixi μ„μΉ

```
C:\Program Files\Laixi\
β”β”€β”€ Laixi.exe           β† Laixi μ•± (WebSocket μ„λ²„)
β”β”€β”€ Scripts\            β† μ¤ν¬λ¦½νΈ ν΄λ”
β”‚   β””β”€β”€ doai\           β† ν”„λ΅μ νΈ μ¤ν¬λ¦½νΈ (μ‹¬λ³Όλ¦­ λ§ν¬)
β””β”€β”€ tools\platform-tools β† ADB ν¬ν•¨
```

### μ¤ν¬λ¦½νΈ μ‹¬λ³Όλ¦­ λ§ν¬ μ„¤μ •

κ΄€λ¦¬μ κ¶ν• PowerShellμ—μ„ μ‹¤ν–‰:

```powershell
# λ°©λ²• 1: μ„¤μ • μ¤ν¬λ¦½νΈ μ‚¬μ©
cd local\gateway\scripts
powershell -ExecutionPolicy Bypass -File setup_laixi_link.ps1

# λ°©λ²• 2: μλ™ μ„¤μ •
$source = "D:\exe.blue\aifarm\local\gateway\scripts\laixi"
$target = "C:\Program Files\Laixi\Scripts\doai"
New-Item -ItemType SymbolicLink -Path $target -Target $source
```

### Laixi μ‹¤ν–‰

1. `C:\Program Files\Laixi\Laixi.exe` μ‹¤ν–‰
2. λ””λ°”μ΄μ¤ μ—°κ²° ν™•μΈ
3. Gatewayκ°€ μλ™μΌλ΅ `ws://127.0.0.1:22221/`μ— μ—°κ²°

### Gatewayμ—μ„ Laixi μ‚¬μ©

```bash
# local/gateway/.env
LAIXI_ENABLED=true
LAIXI_URL=ws://127.0.0.1:22221/
```

### Laixi μ—†μ΄ μ‹¤ν–‰

Laixi μ—†μ΄λ„ Gatewayλ” μ§μ ‘ ADBλ΅ λ™μ‘ν•©λ‹λ‹¤:

```bash
# local/gateway/.env
LAIXI_ENABLED=false
```

---

## Quick Start (TL;DR)

```bash
# (μµμ…) Laixi μ•± μ‹¤ν–‰
"C:\Program Files\Laixi\Laixi.exe"

# ν„°λ―Έλ„ 1: Cloud Gateway
cd services/cloud-gateway && python main.py

# ν„°λ―Έλ„ 2: Local Gateway
cd local/gateway && npm start

# ν„°λ―Έλ„ 3: Frontend
cd apps/web && npm run dev

# λΈλΌμ°μ €
http://localhost:3000/admin/command
```

---

## λ‹¨μ„ ν…μ¤νΈ μ¤ν¬λ¦½νΈ

κ° μ»΄ν¬λ„νΈλ¥Ό λ…λ¦½μ μΌλ΅ ν…μ¤νΈν•λ ¤λ©΄:

```bash
# Cloud Gatewayλ§ ν…μ¤νΈ
scripts\test_1_cloud_gateway.bat

# Local Gatewayλ§ ν…μ¤νΈ
scripts\test_2_local_gateway.bat

# Frontendλ§ ν…μ¤νΈ
scripts\test_3_frontend.bat# μ „μ²΄ ν†µν•© ν…μ¤νΈ
scripts\test_all.bat
```
