# ============================================
# DoAi.Me - Docker Compose 구성
# ============================================
# 최종 기술 스택 (Orion 결정):
# - Gateway: Node.js + Express + adbkit (기기 관리)
# - Backend: Python + FastAPI (복잡한 계산)
# - Database: Supabase (클라우드)
# ============================================

version: '3.8'

services:
  # ============================================
  # Gateway Server (Node.js)
  # ============================================
  # 역할: 600대 Android 기기 연결 관리 및 명령 전송
  # 왜 Node.js? adbkit의 trackDevices()가 비동기 기기 추적에 우수
  doai-gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: doai-gateway
    restart: unless-stopped
    ports:
      - "3100:3100"
    environment:
      - NODE_ENV=production
      - GATEWAY_PORT=3100
      - ADB_HOST=host.docker.internal  # 호스트의 ADB 서버 접근
      - ADB_PORT=5037
      - LOG_LEVEL=info
    volumes:
      - ./gateway/logs:/app/logs
      - /dev/bus/usb:/dev/bus/usb  # USB 장치 접근 (Linux)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - doai-net

  # ============================================
  # Backend API Server (Python/FastAPI)
  # ============================================
  # 역할: 복잡한 계산 (타락도, 의사결정)
  # 단순 계산(유지비)은 Supabase Database Function 사용
  doai-api:
    build:
      context: ./backend/api
      dockerfile: Dockerfile
    container_name: doai-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - DEBUG=false
      - LOG_LEVEL=INFO
      # Supabase 연결
      - DOAI_ME_SUPABASE_URL=${DOAI_ME_SUPABASE_URL}
      - DOAI_ME_SUPABASE_KEY=${DOAI_ME_SUPABASE_KEY}
      # OpenAI (의사결정 보조)
      - DOAI_ME_OPENAI_API_KEY=${DOAI_ME_OPENAI_API_KEY}
      # 경제 시스템 설정
      - MAINTENANCE_BASE_COST=10.0
      - MAINTENANCE_MIN_COST=5.0
      - MAINTENANCE_MAX_COST=50.0
      - CORRUPTION_DECAY_RATE=0.001
      - MAX_CORRUPTION_PER_COMMISSION=0.05
    volumes:
      - ./backend/api:/app
    networks:
      - doai-net
    depends_on:
      - doai-gateway

  # ============================================
  # n8n Workflow Automation
  # ============================================
  # 역할: 오케스트레이션 (두뇌)
  # - 스케줄링 (매일 유지비 차감)
  # - 워크플로우 자동화
  # - Gateway/Backend 연결
  doai-n8n:
    image: n8nio/n8n:latest
    container_name: doai-n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-doaime2025}
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678}
      - GENERIC_TIMEZONE=Asia/Seoul
      # DoAi.Me 서비스 연결
      - DOAI_GATEWAY_URL=http://doai-gateway:3100
      - DOAI_API_URL=http://doai-api:8000
      - PERSONA_SERVICE_URL=${PERSONA_SERVICE_URL:-http://host.docker.internal:8006}
      # Supabase 직접 연결 (간단한 쿼리용)
      - DOAI_ME_SUPABASE_URL=${DOAI_ME_SUPABASE_URL}
      - DOAI_ME_SUPABASE_KEY=${DOAI_ME_SUPABASE_KEY}
    volumes:
      - doai_n8n_data:/home/node/.n8n
      - ./backend/n8n/workflows:/home/node/workflows:ro
    networks:
      - doai-net

# ============================================
# Networks
# ============================================
networks:
  doai-net:
    name: doai-net
    driver: bridge

# ============================================
# Volumes
# ============================================
volumes:
  doai_n8n_data:
    name: doai-n8n-data
