<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoAi.Me - Screen Stream Test</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #050508 0%, #0a0a15 50%, #0f0a1a 100%);
            color: #f0f0f0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }
        
        h1 {
            color: #E6B84D;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .control-panel {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        input, select, button {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            color: #fff;
        }
        
        input::placeholder {
            color: #666;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #E6B84D;
        }
        
        button {
            background: #E6B84D;
            color: #0a0a0f;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #d4a53d;
            transform: translateY(-1px);
        }
        
        button:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            transform: none;
        }
        
        .stream-container {
            position: relative;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 2px solid rgba(230, 184, 77, 0.2);
        }
        
        #videoCanvas {
            display: block;
            background: #0a0a0f;
        }
        
        .status-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        
        .status-left {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(0,0,0,0.7);
            border-radius: 20px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }
        
        .status-dot.connecting { background: #fbbf24; animation: pulse 1s infinite; }
        .status-dot.connected { background: #22c55e; }
        .status-dot.error { background: #ef4444; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .stats {
            padding: 6px 12px;
            background: rgba(0,0,0,0.7);
            border-radius: 20px;
        }
        
        .offline-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
        }
        
        .offline-overlay.hidden {
            display: none;
        }
        
        .offline-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .offline-text {
            color: #888;
            margin-bottom: 20px;
        }
        
        .logs {
            margin-top: 30px;
            width: 100%;
            max-width: 600px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .log-entry.error { color: #ef4444; }
        .log-entry.success { color: #22c55e; }
        .log-entry.info { color: #3b82f6; }
        
        .hex-dump {
            margin-top: 20px;
            padding: 16px;
            background: #0a0a0f;
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            overflow-x: auto;
            white-space: pre;
            max-height: 200px;
            overflow-y: auto;
            color: #0f0;
        }
    </style>
</head>
<body>
    <h1>üé≠ DoAi.Me Screen Stream</h1>
    <p class="subtitle">Tracer Bullet #1: ÏãúÎÉÖÏä§ Ïó∞Í≤∞ (ÌôîÎ©¥ Ïä§Ìä∏Î¶¨Î∞ç)</p>
    
    <div class="control-panel">
        <input type="text" id="deviceId" placeholder="Device ID (Ïòà: abc12345)" value="">
        <select id="quality">
            <option value="low">Ï†ÄÌôîÏßà (480p, 10fps)</option>
            <option value="medium" selected>Ï§ëÌôîÏßà (720p, 15fps)</option>
            <option value="high">Í≥†ÌôîÏßà (1080p, 30fps)</option>
        </select>
        <button id="connectBtn" onclick="connect()">‚ñ∂ Ïó∞Í≤∞</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>‚èπ Ïó∞Í≤∞ Ìï¥Ï†ú</button>
    </div>
    
    <div class="stream-container">
        <canvas id="videoCanvas" width="405" height="720"></canvas>
        
        <div class="status-bar">
            <div class="status-left">
                <span id="statusDot" class="status-dot"></span>
                <span id="statusText">ÎåÄÍ∏∞ Ï§ë</span>
            </div>
            <div class="stats" id="stats">- FPS | 0 KB</div>
        </div>
        
        <div id="offlineOverlay" class="offline-overlay">
            <div class="offline-icon">üì∫</div>
            <div class="offline-text">Device IDÎ•º ÏûÖÎ†•ÌïòÍ≥† Ïó∞Í≤∞ÌïòÏÑ∏Ïöî</div>
        </div>
    </div>
    
    <div class="logs" id="logs">
        <div class="log-entry info">[INFO] DoAi.Me Screen Stream Test Ï§ÄÎπÑ ÏôÑÎ£å</div>
    </div>
    
    <div id="hexDump" class="hex-dump" style="display: none;"></div>
    
    <script src="./scrcpy-client.js"></script>
    <script>
        let client = null;
        let firstDataReceived = false;
        let dataBuffer = [];
        
        const elements = {
            deviceId: document.getElementById('deviceId'),
            quality: document.getElementById('quality'),
            connectBtn: document.getElementById('connectBtn'),
            disconnectBtn: document.getElementById('disconnectBtn'),
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            stats: document.getElementById('stats'),
            offlineOverlay: document.getElementById('offlineOverlay'),
            logs: document.getElementById('logs'),
            hexDump: document.getElementById('hexDump'),
            canvas: document.getElementById('videoCanvas')
        };
        
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            elements.logs.appendChild(entry);
            elements.logs.scrollTop = elements.logs.scrollHeight;
        }
        
        function setStatus(state, text) {
            elements.statusDot.className = `status-dot ${state}`;
            elements.statusText.textContent = text;
        }
        
        function showHexDump(data) {
            // Ï≤´ 100Î∞îÏù¥Ìä∏ Hex Dump ÌëúÏãú
            const bytes = new Uint8Array(data.slice(0, 100));
            let hex = 'First 100 bytes received (Binary data detected):\n\n';
            
            for (let i = 0; i < bytes.length; i += 16) {
                const chunk = bytes.slice(i, i + 16);
                const hexPart = Array.from(chunk)
                    .map(b => b.toString(16).padStart(2, '0').toUpperCase())
                    .join(' ');
                const asciiPart = Array.from(chunk)
                    .map(b => b >= 32 && b < 127 ? String.fromCharCode(b) : '.')
                    .join('');
                
                hex += `${i.toString(16).padStart(4, '0').toUpperCase()}: ${hexPart.padEnd(48)} ${asciiPart}\n`;
            }
            
            // H.264 NAL Unit ÏãúÏûë ÏΩîÎìú ÌôïÏù∏
            if (bytes[0] === 0x00 && bytes[1] === 0x00 && bytes[2] === 0x00 && bytes[3] === 0x01) {
                hex += '\n‚úÖ H.264 NAL Unit detected (start code: 00 00 00 01)';
                const nalType = bytes[4] & 0x1F;
                hex += `\n   NAL Unit Type: ${nalType}`;
            } else if (bytes[0] === 0x00 && bytes[1] === 0x00 && bytes[2] === 0x01) {
                hex += '\n‚úÖ H.264 NAL Unit detected (short start code: 00 00 01)';
            }
            
            elements.hexDump.textContent = hex;
            elements.hexDump.style.display = 'block';
        }
        
        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ interval ID (Ï†ïÎ¶¨Ïö©)
        let statsInterval = null;
        
        async function connect() {
            const deviceId = elements.deviceId.value.trim();
            if (!deviceId) {
                alert('Device IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
                return;
            }
            
            const quality = elements.quality.value;
            const wsUrl = `ws://${location.host}/ws/stream/${deviceId}?quality=${quality}`;
            
            log(`Ïó∞Í≤∞ ÏãúÎèÑ: ${wsUrl}`, 'info');
            setStatus('connecting', 'Ïó∞Í≤∞ Ï§ë...');
            elements.offlineOverlay.classList.add('hidden');
            
            elements.connectBtn.disabled = true;
            elements.disconnectBtn.disabled = false;
            
            // Í∏∞Ï°¥ interval Ï†ïÎ¶¨ (Ï§ëÎ≥µ ÏÉùÏÑ± Î∞©ÏßÄ)
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
            
            // ScrcpyClient Ï¥àÍ∏∞Ìôî
            client = new ScrcpyClient(elements.canvas, wsUrl);
            
            // ÏõêÎ≥∏ Î©îÏãúÏßÄ Ìï∏Îì§Îü¨ ÎûòÌïë (Hex DumpÏö©)
            const originalHandleVideoData = client._handleVideoData.bind(client);
            client._handleVideoData = function(data) {
                if (!firstDataReceived) {
                    firstDataReceived = true;
                    log(`üéâ Ï≤´ Î∞îÏù¥ÎÑàÎ¶¨ Îç∞Ïù¥ÌÑ∞ ÏàòÏã†! (${data.byteLength} bytes)`, 'success');
                    showHexDump(data);
                }
                originalHandleVideoData(data);
            };
            
            try {
                await client.connect();
                log('‚úÖ Ïó∞Í≤∞ ÏÑ±Í≥µ!', 'success');
                setStatus('connected', 'Ïó∞Í≤∞Îê®');
                
                // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ (interval ID Ï†ÄÏû•)
                statsInterval = setInterval(() => {
                    if (client && client.isConnected) {
                        const stats = client.getStats();
                        const kb = (stats.bytesReceived / 1024).toFixed(1);
                        elements.stats.textContent = `${stats.fps} FPS | ${kb} KB`;
                    }
                }, 1000);
                
            } catch (err) {
                log(`‚ùå Ïó∞Í≤∞ Ïã§Ìå®: ${err.message}`, 'error');
                setStatus('error', 'Ïó∞Í≤∞ Ïã§Ìå®');
                elements.offlineOverlay.classList.remove('hidden');
                elements.connectBtn.disabled = false;
                elements.disconnectBtn.disabled = true;
                
                // Ïó∞Í≤∞ Ïã§Ìå® Ïãú interval Ï†ïÎ¶¨
                if (statsInterval) {
                    clearInterval(statsInterval);
                    statsInterval = null;
                }
            }
        }
        
        function disconnect() {
            // ÌÜµÍ≥Ñ interval Ï†ïÎ¶¨ (Î©îÎ™®Î¶¨ ÎàÑÏàò Î∞©ÏßÄ)
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
            
            if (client) {
                client.disconnect();
                client = null;
            }
            
            firstDataReceived = false;
            log('Ïó∞Í≤∞ Ìï¥Ï†úÎê®', 'info');
            setStatus('', 'ÎåÄÍ∏∞ Ï§ë');
            elements.offlineOverlay.classList.remove('hidden');
            elements.connectBtn.disabled = false;
            elements.disconnectBtn.disabled = true;
        }
        
        // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú deviceId ÏûêÎèô ÏûÖÎ†•
        const urlParams = new URLSearchParams(window.location.search);
        const deviceIdParam = urlParams.get('deviceId');
        if (deviceIdParam) {
            elements.deviceId.value = deviceIdParam;
            log(`Device ID ÏûêÎèô ÏûÖÎ†•: ${deviceIdParam}`, 'info');
        }
    </script>
</body>
</html>


